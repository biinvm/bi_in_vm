<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Flow - Водопадная диаграмма</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .date-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .date-input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 140px;
            transition: border-color 0.2s;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #5470c6;
        }
        
        .apply-btn {
            background: #6a11cb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(106, 17, 203, 0.2);
        }
        
        .apply-btn:hover {
            background: #5a0db3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(106, 17, 203, 0.3);
        }
        
        .apply-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(106, 17, 203, 0.2);
        }
        
        .date-separator {
            color: #666;
            font-size: 16px;
            font-weight: 500;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        #main {
            width: 100%;
            height: 500px;
        }
        
        @media (max-width: 768px) {
            .date-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .date-input {
                width: 100%;
                text-align: center;
            }
            
            .apply-btn {
                width: 100%;
            }
            
            .date-separator {
                display: none;
            }
            
            #main {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Блок выбора периода -->
        <div class="date-controls">
            <input type="date" id="start-date" class="date-input">
            <span class="date-separator">—</span>
            <input type="date" id="end-date" class="date-input">
            <button class="apply-btn" onclick="updateChart()">Применить период</button>
        </div>
        
        <div class="chart-container">
            <div id="main"></div>
        </div>
    </div>

    <script>
        // Данные банковских выписок
        const bankStatements = {
            "2025-01-02": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 99900.0
                }
            },
            "2025-01-03": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 95000.0
                }
            },
            "2025-01-07": {
                "РЕКЛАМА": {
                    "ООО ЯНДЕКС": 41400.0
                }
            },
            "2025-01-08": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 199.0
                },
                "ОФИС": {
                    "ООО ХЭДХАНТЕР": 11376.0
                }
            },
            "2025-01-09": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 77641.51,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 440.19
                },
                "Ресторан, кухня": {
                    "Хошимов Исроил Мамурчонович": 60030.0,
                    "Мансурова Наргис Абдусаттаровна": 14007.0,
                    "Намазова Шохсанам Акром кизи": 14000.0
                }
            },
            "2025-01-10": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 297784.55,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 1245.0
                },
                "ДРУГИЕ": {
                    "40802810938000350651\n143321293930\nИП ДОВГОШЕЯ Р. А.": 17300.0
                },
                "Касса": {
                    "Власова Полина Александровна": 13000.0,
                    "Челахова Инна Геннадиевна": 13000.0,
                    "Изосимова Анастасия Левановна": 12000.0
                },
                "ОФИС": {
                    "ООО Индевар": 9000.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ООО ФЕЛИСА": 149397.02,
                    "ООО АСТ-ИНТЕРНЭШНЛ ИНВАЭРОНМЭНТ": 89616.52,
                    "ООО МИЛАРИ": 48540.28,
                    "ООО ГУДВИН-М": 29725.05
                },
                "Помрежи": {
                    "Филимонова-Волкова Вероника Александровна": 12000.0
                },
                "РЕКВИЗИТ, ФОКУС": {
                    "ООО Агат плюс": 10320.0
                },
                "РЕКЛАМА": {
                    "ООО СМБ-СЕРВИС": 50000.0
                },
                "СТРОЙКА": {
                    "ИП ПОСТНОВ ПЁТР ВЛАДИМИРОВИЧ": 99560.0
                }
            },
            "2025-01-11": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 102655.78
                }
            },
            "2025-01-13": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 11198.37,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 398.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ООО ФЕЛИСА": 122412.85,
                    "ООО СМ": 37147.8,
                    "ООО АГРОБАР ЭКСПРЕСС": 23242.0
                }
            },
            "2025-01-14": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 398.0
                },
                "РЕКЛАМА": {
                    "ООО СМБ-СЕРВИС": 50000.0
                },
                "РЕСТОРАН-ОБОРУДОВАНИЕ": {
                    "ИП ДЖАЛИЛОВ АДИЛ ВИДАДИЕВИЧ": 114480.0
                }
            },
            "2025-01-15": {
                "БАНКЕТ, АНИМАЦИЯ": {
                    "ИП ТОЦКАЯ Д. С.": 93280.0
                },
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 269857.9,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 199.0
                },
                "НАЛОГИ": {
                    "ОСФР ПО Г. МОСКВЕ И МОСКОВСКОЙ ОБЛАСТИ": 21020.0
                },
                "ОФИС": {
                    "АО ПФ СКБ Контур": 13515.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ИНДИВИДУАЛЬНЫЙ ПРЕДПРИНИМАТЕЛЬ КОЗЛОВА ВИКТОРИЯ ПАВЛОВНА": 49150.0
                }
            },
            "2025-01-16": {
                "АХО": {
                    "Архипов Александр Александрович": 11460.0
                },
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 435141.04,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 2218.18
                },
                "ДРУГИЕ": {
                    "40702810700001441093\n7728668371\nООО \"ППК\"": 28048.48
                },
                "Дирекция": {
                    "ИП САХАРОВ ПАВЕЛ ВЛАДИМИРОВИЧ": 36150.0
                },
                "Квесты": {
                    "Лесников Руслан Нуролович": 34958.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ООО ФЕЛИСА": 99504.46,
                    "ООО МИЛАРИ": 55927.76,
                    "ИП ПОДЛУЖНАЯ ЕВГЕНИЯ ГЕННАДЬЕВНА": 32512.53,
                    "ООО АСТ-ИНТЕРНЭШНЛ ИНВАЭРОНМЭНТ": 28726.08,
                    "ООО ГУДВИН-М": 17544.46
                },
                "РЕКЛАМА": {
                    "Лукъянченко Сергей Витальевич": 56000.0
                }
            },
            "2025-01-17": {
                "Актеры": {
                    "Стадник Светлана Владимировна": 19000.0
                },
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 1417013.98,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 4026.01
                },
                "Квесты": {
                    "Мардашов Максим Игоревич": 51000.0
                },
                "ОФИС": {
                    "ООО Индевар": 4500.0,
                    "ООО ЦентрТоргПроект": 1918.83
                },
                "Помрежи": {
                    "Филимонова-Волкова Вероника Александровна": 20250.0
                },
                "Распределение": {
                    "Самойлова Ольга Анатольевна": 53676.83
                },
                "Ресторан, кухня": {
                    "Ли Екатерина Юрьевна": 50000.0
                },
                "Ресторан, офис": {
                    "Казакова Светлана Ивановна": 35000.0
                },
                "Фокус": {
                    "ИП ИВАЧЕВ В. В.": 29000.0
                }
            },
            "2025-01-18": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 221961.49,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 398.0
                },
                "ДРУГИЕ": {
                    "ИП ОГИРЯ АНДРЕЙ СЕРГЕЕВИЧ": 100000.0
                },
                "Дирекция": {
                    "ИП САХАРОВ ПАВЕЛ ВЛАДИМИРОВИЧ": 95000.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ООО ГУДВИН-М": 26293.98
                },
                "РЕСТОРАН-ОБОРУДОВАНИЕ": {
                    "ООО Эксперт Сервис": 10400.0
                }
            },
            "2025-01-19": {
                "Актеры": {
                    "Хатюхин Станислав Александрович": 12000.0
                },
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 188000.0,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 199.0
                }
            },
            "2025-01-20": {
                "БАНКЕТ, АНИМАЦИЯ": {
                    "Соколова Галина Владимировна": 14894.0
                },
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 8795.5,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 2586.2
                },
                "ДРУГИЕ": {
                    "40817810600059478301\n231140956392\nРыкун Даниил Евгеньевич": 12000.0
                },
                "Касса": {
                    "Изосимова Анастасия Левановна": 23000.0,
                    "Власова Полина Александровна": 18000.0,
                    "Челахова Инна Геннадиевна": 14000.0
                },
                "ОФИС": {
                    "ООО Индевар": 9000.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ИНДИВИДУАЛЬНЫЙ ПРЕДПРИНИМАТЕЛЬ КОЗЛОВА ВИКТОРИЯ ПАВЛОВНА": 12040.0
                },
                "РЕКЛАМА": {
                    "ООО СМБ-СЕРВИС": 50000.0
                },
                "ЭЛЕКТРОЭНЕРГИЯ": {
                    "ООО КАСКАД-ЭНЕРГОСБЫТ": 161757.9
                }
            },
            "2025-01-21": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 269618.25,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 2583.0
                },
                "Гардероб": {
                    "Миронова Наталья Анатольевна": 20000.0
                },
                "ПЛОЩАДКА-ОБОРУДОВАНИЕ": {
                    "ООО Мирест": 22590.0
                },
                "ПРОДУКТЫ-РЕСТОРАН": {
                    "ООО МИЛАРИ": 92610.98,
                    "ООО ФЕЛИСА": 50510.95
                },
                "РЕКЛАМА": {
                    "ООО ПК СОЮЗПЕЧАТЬ": 105700.0,
                    "ИП РАЕВ ЕВГЕНИЙ АНДРЕЕВИЧ": 72000.0,
                    "ИП МЕРЗЛЯКОВ И. С.": 62850.0,
                    "Белова Вероника Михайловна": 50000.0,
                    "Гуменяк Нестор Мирославович": 27140.0
                }
            },
            "2025-01-22": {
                "БАНКОВСКИЕ КОМИССИИ": {
                    "ПАО Сбербанк": 251493.0,
                    "ОТДЕЛЕНИЕ N17 ПАО СБЕРБАНК": 398.0
                },
                "РЕКЛАМА": {
                    "ИП Манохин Валерий Вячеславович": 27300.0,
                    "Гуменяк Нестор Мирославович": 15911.0,
                    "ООО ДОЛПРИНТ": 3600.0
                },
                "РЕСТОРАН-ОБОРУДОВАНИЕ": {
                    "ИП Яшин Павел Юрьевич": 50000.0
                }
            }
        };

        let myChart = null;

        // Генерация случайных данных о выручке
        function generateRevenueData(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            const revenues = [];
            for (let i = 0; i < days; i++) {
                revenues.push(Math.floor(Math.random() * 300000) + 200000);
            }
            return revenues;
        }

        // Подготовка данных транзакций с фильтрацией по дате
        function prepareTransactionsData(startDate, endDate) {
            const transactions = [];
            
            // Фильтруем расходы по дате
            for (const [date, categories] of Object.entries(bankStatements)) {
                if (date >= startDate && date <= endDate) {
                    for (const [category, contractors] of Object.entries(categories)) {
                        for (const [contractor, amount] of Object.entries(contractors)) {
                            transactions.push({
                                date: date,
                                category: category,
                                contractor: contractor,
                                amount: amount,
                                type: 'expense'
                            });
                        }
                    }
                }
            }
            
            // Добавляем данные о выручке
            const revenueData = generateRevenueData(startDate, endDate);
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            for (let i = 0; i < days; i++) {
                const currentDate = new Date(start);
                currentDate.setDate(start.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                transactions.push({
                    date: dateStr,
                    category: 'ВЫРУЧКА',
                    contractor: 'Продажи/Услуги',
                    amount: revenueData[i],
                    type: 'revenue'
                });
            }
            
            return transactions;
        }

        // Создание водопадной диаграммы
        function createWaterfallChart(transactions) {
            const chartDom = document.getElementById('main');
            if (!myChart) {
                myChart = echarts.init(chartDom);
            }
            
            // Группируем по категориям
            const categories = {};
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            transactions.forEach(transaction => {
                if (!categories[transaction.category]) {
                    categories[transaction.category] = 0;
                }
                if (transaction.type === 'expense') {
                    categories[transaction.category] -= transaction.amount;
                    totalExpenses += transaction.amount;
                } else {
                    categories[transaction.category] += transaction.amount;
                    totalRevenue += transaction.amount;
                }
            });
            
            // Преобразуем в массивы для ECharts
            const categoryNames = [];
            const categoryValues = [];
            const colors = [];
            
            // Сначала выручка
            categoryNames.push('Начальный баланс');
            categoryValues.push(0);
            colors.push('#3498db');
            
            // Добавляем выручку
            categoryNames.push('ВЫРУЧКА');
            categoryValues.push(totalRevenue);
            colors.push('#2ecc71');
            
            // Затем расходы, отсортированные по сумме
            const expenseCategories = Object.entries(categories)
                .filter(([category, value]) => value < 0 && category !== 'ВЫРУЧКА')
                .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
            
            expenseCategories.forEach(([category, value]) => {
                categoryNames.push(category);
                categoryValues.push(value);
                colors.push('#e74c3c');
            });
            
            categoryNames.push('Итоговый баланс');
            categoryValues.push(totalRevenue - totalExpenses);
            colors.push('#3498db');
            
            // Создаем данные placeholder для водопадной диаграммы
            const placeholderData = [0];
            for (let i = 1; i < categoryValues.length - 1; i++) {
                let sum = 0;
                for (let j = 0; j < i; j++) {
                    sum += categoryValues[j];
                }
                placeholderData.push(sum);
            }
            
            const option = {
                title: {
                    text: 'Водопадная диаграмма Cash Flow',
                    subtext: formatDateRangeDisplay(startDate, endDate),
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function (params) {
                        const tar = params[0];
                        const value = Math.abs(tar.value);
                        const sign = tar.value >= 0 ? '+' : '-';
                        return `<div style="font-weight: bold;">${tar.name}</div>${sign} ${formatCurrency(value)}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: categoryNames,
                    axisLabel: {
                        rotate: 45,
                        interval: 0,
                        fontSize: 11,
                        margin: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: function(value) {
                            return formatCurrencyShort(value);
                        }
                    }
                },
                series: [
                    {
                        name: 'Placeholder',
                        type: 'bar',
                        stack: 'Total',
                        itemStyle: {
                            borderColor: 'transparent',
                            color: 'transparent'
                        },
                        emphasis: {
                            itemStyle: {
                                borderColor: 'transparent',
                                color: 'transparent'
                            }
                        },
                        data: placeholderData
                    },
                    {
                        name: 'Cash Flow',
                        type: 'bar',
                        stack: 'Total',
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: function(params) {
                                const value = Math.abs(params.value);
                                const sign = params.value >= 0 ? '+' : '-';
                                return `${sign}${formatCurrencyShort(value)}`;
                            },
                            fontSize: 10
                        },
                        itemStyle: {
                            color: function(params) {
                                return colors[params.dataIndex];
                            }
                        },
                        data: categoryValues
                    }
                ]
            };

            myChart.setOption(option);
            
            return myChart;
        }

        // Форматирование валюты
        function formatCurrency(value) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Форматирование валюты (короткий вариант)
        function formatCurrencyShort(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + 'K';
            }
            return value.toFixed(0);
        }

        // Форматирование диапазона дат для отображения
        function formatDateRangeDisplay(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            const formatDate = (date) => {
                return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
            };
            
            return `${formatDate(startDate)} - ${formatDate(endDate)}`;
        }

        // Обновление графика
        function updateChart() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Пожалуйста, выберите начальную и конечную даты');
                return;
            }
            
            if (startDate > endDate) {
                alert('Начальная дата не может быть позже конечной');
                return;
            }
            
            const transactions = prepareTransactionsData(startDate, endDate);
            createWaterfallChart(transactions, startDate, endDate);
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Установка дат по умолчанию (январь 2025)
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            startDateInput.value = '2025-01-01';
            endDateInput.value = '2025-01-31';
            
            // Инициализация графика
            updateChart();
            
            // Адаптация к размеру окна
            window.addEventListener('resize', function() {
                if (myChart) {
                    myChart.resize();
                }
            });
        });
    </script>
</body>
</html>